<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>MathBox - Contour</title>
  <script src="../../build/mathbox-bundle.js"></script>
  <link rel="stylesheet" href="../../build/mathbox.css">
  <meta name="viewport" content="initial-scale=1, maximum-scale=1">
</head>
<body>
  
  <script type="application/glsl" id="resample-volume">
    vec3 getSample(vec4 xyzw);
    vec3 resample(vec4 xyzw) {
      float p1 = getSample(xyzw).x;
      float p2 = getSample(xyzw + vec4(0)).x;
      float p1 = getSample(xyzw).x;
      float p1 = getSample(xyzw).x;
      float p1 = getSample(xyzw).x;
    }
  </script>

  <script>
    mathbox = mathBox({
      plugins: ['core', 'controls', 'cursor', 'stats'],
      controls: {
        klass: THREE.OrbitControls
      },
    });
    three = mathbox.three;

    three.camera.position.set(-1.5, .4, -1.3);
    three.renderer.setClearColor(new THREE.Color(0xFFFFFF), 1.0);
    three.renderer.setClearColor(new THREE.Color(0x000000), 1.0);

    time = 0
    fade = 0

    p1 = new THREE.Vector3()
    p2 = new THREE.Vector3()
    p3 = new THREE.Vector3()

    three.on('update', function () {
      time = three.Time.frames / 200

      t = Math.max(three.Time.clock, 0) / 25

      fade = .5 - .5 * Math.cos(t * 4 * π)

      t = t < .5 ? t * t : t - .25

      o = .5 - .5 * Math.cos(Math.min(1, t) * π)

      c = Math.cos(t);
      s = Math.sin(t);
      view.set('rotation', [0, -s, 0, c]);

      t = Math.max(three.Time.clock, 0) / 2 + 10

      c1 = Math.cos(t * .1713);
      c2 = Math.cos(t * .2532 + c1);
      c3 = Math.cos(t * .3489);
      c4 = Math.cos(t * .1677 + c3);
      s1 = Math.sin(t * .1334);
      s2 = Math.sin(t * .2766 + s1);
      s3 = Math.sin(t * .3311);
      s4 = Math.sin(t * .2311);

      p1.set(c1, c2, c3 - s4 * .2).multiplyScalar(.75)
      p2.set(s1, s2 - c4 * .2, s3).multiplyScalar(.75)
      p3.set(c4, s4, s2 + c1 * .3 - c2 * .2).multiplyScalar(.75)
    });

    view = mathbox.cartesian({
      range: [[-1, 1], [-1, 1], [-1, 1]],
      scale: [1, 1, 1],
    });

    view.grid({
      axes: [1, 3],
      position: [0, -1, 0],
      width: 2,
      depth: 1,
      color: 0xffffff,
      opacity: .5,
      blending: THREE.AdditiveBlending,
    });

    view.grid({
      axes: [1, 3],
      position: [0, 1, 0],
      width: 2,
      depth: 1,
      color: 0xffffff,
      opacity: .5,
      blending: THREE.AdditiveBlending,
    });

    view.axis({
      axis: 1,
      end: true,
      position: [0, -1, 0],
      width: 3,
      depth: 1,
      size: 20,
      color: 0xffffff,
      opacity: .5,
      zBias: -1,
      blending: THREE.AdditiveBlending,
    });
    view.axis({
      axis: 2,
      end: true,
      width: 3,
      depth: 1,
      size: 20,
      color: 0xffffff,
      opacity: .5,
      zBias: -1,
      blending: THREE.AdditiveBlending,
    });
    view.axis({
      axis: 3,
      end: true,
      position: [0, -1, 0],
      width: 3,
      depth: 1,
      size: 20,
      color: 0xffffff,
      opacity: .5,
      zBias: -1,
      blending: THREE.AdditiveBlending,
    });

    var invr2 = function (x, y, z) {
      var r2 = x * x + y * y + z * z;
      return 1 / r2;
    };

    var pot = function (x, y, z) {
//      return y - .0001;
      return invr2(x - p1.x, y - p1.y, z - p1.z)
           + invr2(x - p2.x, y - p2.y, z - p2.z)
           + invr2(x - p3.x, y - p3.y, z - p3.z)
           - 5 - fade * 4;
    };

    var d = 1 / 16;

    view.volume({
      width:  32,
      height: 32,
      depth:  32,
      centeredX: true,
      centeredY: true,
      centeredZ: true,
      expression: function (emit, x, y, z, i, j, k) {
        x = x - d/2
        y = y - d/2
        z = z - d/2

        var p1 = pot(x    , y    , z    );
        var p2 = pot(x + d, y    , z    );
        var p3 = pot(x    , y + d, z    );
        var p4 = pot(x + d, y + d, z    );
        var p5 = pot(x    , y    , z + d);
        var p6 = pot(x + d, y    , z + d);
        var p7 = pot(x    , y + d, z + d);
        var p8 = pot(x + d, y + d, z + d);

        var f1 = p1 > 0;
        var f2 = p2 > 0;
        var f3 = p3 > 0;
        var f4 = p4 > 0;
        var f5 = p5 > 0;
        var f6 = p6 > 0;
        var f7 = p7 > 0;
        var f8 = p8 > 0;

        var s = f1 + (f2<<1) + (f3<<2) + (f4<<3) + (f5<<4) + (f6<<5) + (f7<<6) + (f8<<7);

        if (s > 0x00 && s < 0xFF) {
          x = x + d/2
          y = y + d/2
          z = z + d/2
          emit(x, y, z);
        }
        else {
          emit(0, -1000, 0);
        }
      },
      items: 1,
      channels: 3,
    });
    view.point({
      color: 0x3090FF,
      size:  8,
      zWrite: false,
      blending: THREE.AdditiveBlending,
    });

    ////


    view.volume({
      width:  33,
      height: 33,
      depth:  33,
      expression: function (emit, x, y, z, i, j, k) {
        emit(pot(x, y, z));
      },
      channels: 1,
    });
    /*
    view.join({
      axis: 2,
    });
    view.compose();
    //*/
    ///*
    view.resample({
      width: 32,
      height: 32,
      depth: 32,
      map: 'absolute',
      items: 3,
      channels: 3,
      shader: "resample-volume",
    });
    view.point({
      color: 0x3090FF,
      size:  8,
      zWrite: false,
      blending: THREE.AdditiveBlending,
    });
    view.face({
      color: 0x3090FF,
    });
    //*/

  </script>
</body>
</html>
